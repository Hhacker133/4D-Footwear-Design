<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Sneaker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Glassmorphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

        /* Loading spinner */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: hwb(0 100% 0%);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Page transition */
        .page {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .page.hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
        }
        
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full flex flex-col">

    <!-- Background Gradient -->
    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-900 via-gray-900 to-purple-900 opacity-80 -z-10"></div>
    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-blob -z-10"></div>
    <div class="absolute top-1/2 right-1/4 w-96 h-96 bg-indigo-600 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-blob animation-delay-2000 -z-10"></div>

    <main class="flex-grow overflow-hidden relative">
        <!-- Login Page -->
        <div id="login-page" class="page absolute inset-0 flex flex-col justify-center items-center p-4">
            <div class="w-full max-w-sm space-y-4">
                <div class="glass-card rounded-2xl p-6 text-center">
                    <h1 class="text-3xl font-bold tracking-tight">Royal Ravi</h1>
                    <p class="text-indigo-300">The Future of Footwear</p>
                </div>
                <div class="glass-card rounded-2xl p-6 space-y-4">
                    <h2 class="text-xl font-semibold text-center">Welcome Back</h2>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-200 mb-1">Email</label>
                        <input type="email" id="email" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="user@example.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-200 mb-1">Password</label>
                        <input type="password" id="password" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="••••••••">
                    </div>
                    <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2.5 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Login</button>
                </div>
            </div>
        </div>

        <!-- Store Page (formerly Product Detail Page) -->
        <div id="store-page" class="page absolute inset-0 flex flex-col h-full hidden">
            <!-- 3D Canvas -->
            <div id="canvas-container" class="w-full h-1/2 md:h-2/3 flex-shrink-0 relative">
                <div id="loader" class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-30">
                    <div class="flex flex-col items-center"><div class="loader mb-4"></div><p>Loading 3D Model...</p></div>
                </div>
            </div>
            <!-- UI Cards -->
            <div class="w-full flex-grow overflow-y-auto p-4 space-y-4 custom-scrollbar">
                <div class="glass-card rounded-2xl p-6">
                    <h1 class="text-3xl font-bold tracking-tight">Light Speed Runner</h1>
                    <p class="text-xl text-indigo-300 mt-1">$ 2001.00</p>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-medium text-gray-200">Description</h3>
                        <button id="generate-description-btn" class="text-xs bg-indigo-500 bg-opacity-50 hover:bg-opacity-75 text-white font-bold py-1 px-2 rounded-lg transition-all duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="gen-desc-btn-text">Generate ✨</span>
                            <div id="gen-desc-loader" class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin ml-2 hidden"></div>
                        </button>
                    </div>
                    <div id="description-container" class="max-h-24 overflow-y-auto custom-scrollbar pr-2">
                        <p id="product-description" class="text-gray-300 text-sm">Engineered for the future of urban exploration. Features a proprietary Zero-G foam midsole and a breathable, adaptive mesh upper. The design is inspired by interstellar nebulae, blending performance with cosmic aesthetics.</p>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-sm font-medium text-gray-200 mb-2">Colorway</h3>
                        <div class="flex space-x-3"><button id="color-cosmic" class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-700 via-purple-800 to-indigo-900 border-2 border-white ring-2 ring-offset-2 ring-offset-transparent ring-white" title="Cosmic Graphite"></button><button id="color-supernova" class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 via-red-500 to-yellow-500 border-2 border-transparent" title="Supernova Flare"></button><button id="color-nebula" class="w-8 h-8 rounded-full bg-gradient-to-br from-teal-400 via-cyan-500 to-blue-600 border-2 border-transparent" title="Nebula Blue"></button></div>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="size" class="block text-sm font-medium text-gray-200 mb-2">Size</label>
                            <select id="size" name="size" class="block w-full bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-400"><option selected>6</option><option>7</option><option selected>8</option><option>9</option><option>10</option><option>11</option></select>
                        </div>
                        <div class="flex items-end"><button id="add-to-cart-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center"><span id="btn-text">Add to Cart</span><svg id="btn-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></button></div>
                    </div>
                </div>
                 <!-- Added more product cards for a richer store feel -->
                <div class="glass-card rounded-2xl p-4 flex items-center gap-4 opacity-50">
                    <div class="w-16 h-16 bg-white bg-opacity-10 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    </div>
                    <div>
                        <h3 class="font-semibold">Nova Strider</h3>
                        <p class="text-xs text-gray-400">Coming Soon</p>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-4 flex items-center gap-4 opacity-50">
                    <div class="w-16 h-16 bg-white bg-opacity-10 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    </div>
                    <div>
                        <h3 class="font-semibold">Volt Racer</h3>
                        <p class="text-xs text-gray-400">Coming Soon</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Page -->
        <div id="cart-page" class="page absolute inset-0 flex flex-col p-4 hidden">
            <h1 class="text-3xl font-bold tracking-tight text-center mb-4 flex-shrink-0">My Cart</h1>
            <div id="cart-items-container" class="flex-grow overflow-y-auto space-y-4 custom-scrollbar"></div>
            <div id="cart-summary" class="flex-shrink-0 pt-4"></div>
        </div>

        <!-- Delivery/Payment Page -->
        <div id="delivery-page" class="page absolute inset-0 flex flex-col p-4 hidden">
            <h1 class="text-3xl font-bold tracking-tight text-center mb-4 flex-shrink-0">Checkout</h1>
            <div class="flex-grow overflow-y-auto space-y-4 custom-scrollbar">
                <div class="glass-card rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4">Shipping Address</h2>
                    <div class="space-y-3">
                        <input type="text" placeholder="Full Name" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <input type="text" placeholder="Address" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <input type="text" placeholder="City" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <input type="text" placeholder="Postal Code" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    </div>
                </div>
                 <div class="glass-card rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4">Payment Method</h2>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 bg-white bg-opacity-10 rounded-lg">
                            <input type="radio" name="payment" value="razorpay" class="form-radio h-5 w-5 text-indigo-500 bg-transparent border-indigo-400 focus:ring-indigo-500" checked>
                            <span class="ml-3">Razorpay (Card, UPI)</span>
                        </label>
                        <label class="flex items-center p-3 bg-white bg-opacity-10 rounded-lg">
                            <input type="radio" name="payment" value="cod" class="form-radio h-5 w-5 text-indigo-500 bg-transparent border-indigo-400 focus:ring-indigo-500">
                            <span class="ml-3">Cash on Delivery</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="flex-shrink-0 pt-4">
                <button id="place-order-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Place Order</button>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page absolute inset-0 flex flex-col justify-center items-center p-4 hidden">
             <div class="w-full max-w-sm space-y-4">
                <div class="glass-card rounded-2xl p-6 flex flex-col items-center">
                    <img src="WhatsApp Image 2025-08-04 at 8.54.04 PM (1).jpeg" class="w-24 h-24 rounded-full border-2 border-indigo-400 mb-4" alt="Avatar">
                    <h2 class="text-2xl font-bold">Royal Ravi</h2>
                    <p class="text-indigo-300">roaboutcollection@gmail.com</p>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="font-semibold mb-2">Order History</h3>
                    <p class="text-sm text-gray-400 text-center py-4">No recent orders.</p>
                </div>
                <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2.5 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Logout</button>
            </div>
        </div>
    </main>
    
    <!-- Order Confirmation Modal -->
    <div id="order-confirmation-modal" class="modal-overlay absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="glass-card rounded-2xl p-8 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h2 class="text-2xl font-bold">Order Placed!</h2>
            <p class="text-gray-300 mt-2">Thank you for your purchase.</p>
        </div>
    </div>


    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="w-full glass-card rounded-t-2xl p-2 flex-shrink-0 hidden">
        <div class="flex justify-around w-full max-w-sm mx-auto">
            <button data-page="store" class="nav-btn flex flex-col items-center text-indigo-300 p-2 rounded-lg w-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span class="text-xs mt-1">Store</span>
            </button>
            <button data-page="cart" class="nav-btn flex flex-col items-center text-gray-400 p-2 rounded-lg w-20 relative">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                <span class="text-xs mt-1">Cart</span>
                <span id="cart-badge" class="absolute top-1 right-3 text-xs bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
            </button>
            <button data-page="profile" class="nav-btn flex flex-col items-center text-gray-400 p-2 rounded-lg w-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                <span class="text-xs mt-1">Profile</span>
            </button>
        </div>
    </nav>

    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        let scene, camera, renderer, controls, sneakerModel;
        let isThreeJsInitialized = false;

        const pages = {
            login: document.getElementById('login-page'),
            store: document.getElementById('store-page'),
            cart: document.getElementById('cart-page'),
            delivery: document.getElementById('delivery-page'),
            profile: document.getElementById('profile-page'),
        };
        const bottomNav = document.getElementById('bottom-nav');
        const navButtons = document.querySelectorAll('.nav-btn');
        const cartBadge = document.getElementById('cart-badge');
        const orderModal = document.getElementById('order-confirmation-modal');

        let isLoggedIn = false;
        let currentPage = 'login';
        let cart = [];
        let selectedColor = 'Cosmic Graphite';

        function navigateTo(pageName) {
            if (!isLoggedIn && pageName !== 'login') {
                navigateTo('login');
                return;
            }
            
            currentPage = pageName;
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            if (pages[pageName]) {
                pages[pageName].classList.remove('hidden');
            }

            const canvasContainer = document.getElementById('canvas-container');
            if (pageName === 'store') {
                if (!isThreeJsInitialized) initThreeJs();
                canvasContainer.style.display = 'block';
                 if(renderer) renderer.domElement.style.display = 'block';
            } else {
                if(renderer) renderer.domElement.style.display = 'none';
            }

            navButtons.forEach(btn => {
                btn.classList.toggle('text-indigo-300', btn.dataset.page === pageName);
                btn.classList.toggle('text-gray-400', btn.dataset.page !== pageName);
            });
        }

        function handleLogin() {
            isLoggedIn = true;
            bottomNav.classList.remove('hidden');
            navigateTo('store');
        }

        function handleLogout() {
            isLoggedIn = false;
            bottomNav.classList.add('hidden');
            navigateTo('login');
        }
        
        function updateCart() {
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartSummaryContainer = document.getElementById('cart-summary');
            cartItemsContainer.innerHTML = '';

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-center text-gray-400">Your cart is empty.</p>`;
                cartSummaryContainer.innerHTML = '';
            } else {
                cart.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'glass-card rounded-2xl p-4 flex items-center gap-4';
                    itemElement.innerHTML = `
                        <div class="w-16 h-16 bg-white bg-opacity-10 rounded-lg flex items-center justify-center">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                        </div>
                        <div class="flex-grow">
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-300">Size: ${item.size} | ${item.color}</p>
                            <p class="font-bold text-indigo-300">$ ${item.price.toFixed(2)}</p>
                        </div>
                        <button data-index="${index}" class="remove-item-btn text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });

                const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
                cartSummaryContainer.innerHTML = `
                    <div class="glass-card rounded-2xl p-4 space-y-2">
                        <div class="flex justify-between text-gray-300"><p>Subtotal</p><p>$ ${subtotal.toFixed(2)}</p></div>
                        <div class="flex justify-between text-gray-300"><p>Shipping</p><p>$ 0.00</p></div>
                        <div class="flex justify-between font-bold text-xl"><p>Total</p><p>$ ${subtotal.toFixed(2)}</p></div>
                    </div>
                    <button id="checkout-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Proceed to Checkout</button>
                `;
                document.getElementById('checkout-btn').addEventListener('click', () => navigateTo('delivery'));
            }
            
            cartBadge.textContent = cart.length;
            cartBadge.classList.toggle('hidden', cart.length === 0);
            
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    cart.splice(e.target.dataset.index, 1);
                    updateCart();
                });
            });
        }

        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageName = btn.dataset.page;
                if (pageName === 'cart') updateCart();
                navigateTo(pageName);
            });
        });

        document.getElementById('place-order-btn').addEventListener('click', () => {
            orderModal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                orderModal.classList.add('opacity-0', 'pointer-events-none');
                cart = [];
                updateCart();
                navigateTo('store');
            }, 2500);
        });

        function initThreeJs() {
            if (isThreeJsInitialized) {
                renderer.domElement.style.display = 'block';
                return;
            }
            isThreeJsInitialized = true;
            const canvasContainer = document.getElementById('canvas-container');
            const loaderElement = document.getElementById('loader');

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, 0.4, 2.5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.outputEncoding = THREE.sRGBEncoding;
            canvasContainer.appendChild(renderer.domElement);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 1.5;
            controls.maxDistance = 5;
            controls.target.set(0, 0.4, 0);
            
            new RGBELoader().load('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/studio_small_03_1k.hdr', t => {
                t.mapping = THREE.EquirectangularReflectionMapping;
                scene.environment = t;
            });

            new GLTFLoader().load('https://threejs.org/examples/models/gltf/MaterialsVariantsShoe/glTF/MaterialsVariantsShoe.gltf', gltf => {
                sneakerModel = gltf.scene;
                sneakerModel.scale.set(8, 8, 8); // Made sneaker smaller
                sneakerModel.position.set(0, 0, 0);
                sneakerModel.rotation.y = -Math.PI / 4;
                scene.add(sneakerModel);
                loaderElement.style.display = 'none';
                animate();
            }, undefined, e => console.error(e));

            window.addEventListener('resize', () => {
                camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            }, false);

            setupUIEventListeners();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (sneakerModel && currentPage === 'store') {
                 sneakerModel.rotation.y += 0.005;
            }
            if(renderer) renderer.render(scene, camera);
        }

        function setupUIEventListeners() {
            const colorButtons = [
                { id: 'color-cosmic', materialIndex: 0, name: 'Cosmic Graphite' }, 
                { id: 'color-supernova', materialIndex: 1, name: 'Supernova Flare' }, 
                { id: 'color-nebula', materialIndex: 2, name: 'Nebula Blue' }
            ];
            colorButtons.forEach(btnInfo => {
                document.getElementById(btnInfo.id).addEventListener('click', () => {
                    selectedColor = btnInfo.name;
                    if (sneakerModel && sneakerModel.userData.variants) {
                        const variant = sneakerModel.userData.variants[btnInfo.materialIndex];
                        sneakerModel.traverse(o => {
                            if (o.isMesh && o.userData.gltfExtensions && o.userData.gltfExtensions.KHR_materials_variants) {
                                const mapping = o.userData.gltfExtensions.KHR_materials_variants.mappings.find(m => m.variant === variant);
                                if(mapping) o.material = mapping.material;
                            }
                        });
                    }
                    document.querySelectorAll('[id^="color-"]').forEach(b => b.classList.remove('border-white', 'ring-2', 'ring-offset-2', 'ring-offset-transparent', 'ring-white'));
                    document.getElementById(btnInfo.id).classList.add('border-white', 'ring-2', 'ring-offset-2', 'ring-offset-transparent', 'ring-white');
                });
            });

            const addToCartBtn = document.getElementById('add-to-cart-btn');
            addToCartBtn.addEventListener('click', () => {
                const sizeEl = document.getElementById('size');
                const item = {
                    id: Date.now(),
                    name: 'Aether Runner',
                    price: 749.00,
                    size: sizeEl.options[sizeEl.selectedIndex].text,
                    color: selectedColor
                };
                cart.push(item);
                updateCart();

                addToCartBtn.classList.add('bg-green-500');
                document.getElementById('btn-text').textContent = 'Added!';
                document.getElementById('btn-icon').classList.remove('hidden');
                setTimeout(() => {
                    addToCartBtn.classList.remove('bg-green-500');
                    document.getElementById('btn-text').textContent = 'Add to Cart';
                    document.getElementById('btn-icon').classList.add('hidden');
                }, 2000);
            });

            document.getElementById('generate-description-btn').addEventListener('click', async () => {
                const btn = document.getElementById('generate-description-btn');
                const btnText = document.getElementById('gen-desc-btn-text');
                const loader = document.getElementById('gen-desc-loader');
                const descP = document.getElementById('product-description');
                
                btnText.textContent = 'Generating...';
                loader.classList.remove('hidden');
                btn.disabled = true;

                const prompt = `Write a short, exciting, futuristic product description for a sneaker called 'Aether Runner'. Keep it under 60 words. Mention its 'Zero-G foam' midsole and 'adaptive mesh' upper.`;
                try {
                    descP.textContent = await callGemini(prompt);
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    descP.textContent = "Error generating description. Please try again.";
                } finally {
                    btnText.textContent = 'Generate ✨';
                    loader.classList.add('hidden');
                    btn.disabled = false;
                }
            });
        }

        async function callGemini(prompt, retries = 3, delay = 1000) {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        // Don't throw on 429, just let it retry
                        if (response.status === 429) {
                           console.warn(`Throttled by API. Retrying in ${delay * (i + 1)}ms...`);
                           await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                           continue; // Skip to the next iteration
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    // Robust response parsing
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0 &&
                        result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error("Invalid response structure from Gemini API:", result);
                        throw new Error("Invalid response structure from Gemini API");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error; // Throw error on last attempt
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                }
            }
            throw new Error("API call failed after all retries.");
        }
        
        // Initial setup
        navigateTo('login');
    </script>
</body>
</html>
